name: Deploy Locadora

on:
  push:
    branches:
      - "main"

jobs:
  test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node-version: [12.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.JS ${{matrix.node-version}}
        uses: actions/setup-node@v1
        with:
          node-version: ${{matrix.node-version}}
      - run: npm i
      - run: npm run test
  build:
    needs: test
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            git clone git@github.com:lucasffm/phi-locadora.git
            cd phi-locadora
            git pull
            FILE=.env
            if test -f "$FILE"; then
                echo "$FILE exists."
                rm .env
            fi
            echo "
            PORT=${{secrets.PORT}}
            JWT_SECRET=${{secrets.JWT_SECRET}}
            DB_HOST=${{secrets.DB_HOST}}
            DB_USERNAME=${{secrets.DB_USERNAME}}
            DB_PASSWORD=${{secrets.DB_PASSWORD}}
            DB_PORT=${{secrets.DB_PORT}}
            DB_NAME=${{secrets.DB_NAME}}
            VIRTUAL_HOST=${{secrets.VIRTUAL_HOST}}
            " > .env
            docker-compose up -d --build
            
      

